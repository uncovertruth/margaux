machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"

  pre:
    - docker info
    - if [[ -e ~/docker/app.image.tar ]]; then docker load -i ~/docker/app.image.tar; fi
    - docker build -t uncovertruth/margaux-app .
    - mkdir -p ~/docker
    - docker save uncovertruth/margaux-app > ~/docker/app.image.tar

test:
  override:
    # supervirsord がプロセスを起動するまで時間がかかるので npm test の前に sleep する
    - docker run -it uncovertruth/margaux-app /bin/sh -c "/usr/local/ap/venv/circus/bin/circusd --daemon /etc/circus.ini && sleep 5;npm test"
